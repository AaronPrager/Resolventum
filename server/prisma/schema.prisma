// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String    @id @default(uuid())
  email                    String    @unique
  password                 String
  name                     String
  companyName              String?
  phone                    String?
  address                  String?
  logoUrl                  String?
  venmo                    String?
  zelle                    String?
  verified                 Boolean   @default(false)
  verificationToken        String?
  verificationTokenExpires DateTime?
  // Automatic email settings
  autoEmailEnabled         Boolean   @default(false)
  autoEmailTime            String? // Time in HH:MM format (24-hour)
  autoEmailAddress         String? // Email address to send schedule to
  // File storage settings
  fileStorageType          String?   @default("local") // "local" or "googleDrive"
  googleDriveAccessToken   String? // OAuth access token for Google Drive
  googleDriveRefreshToken  String? // OAuth refresh token for Google Drive
  googleDriveTokenExpiry   DateTime? // When the access token expires
  googleDriveFolderId      String? // Optional: specific folder ID to store files in
  deleted                  Boolean   @default(false) // Soft delete flag
  deletedAt                DateTime? // Timestamp when account was deleted
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  students                 Student[]
  lessons                  Lesson[]
  payments                 Payment[]
  packages                 Package[]
  purchases                Purchase[]
}

model Student {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Student Details
  firstName       String
  lastName        String
  dateOfBirth     DateTime?
  email           String?
  phone           String?
  address         String?
  schoolName      String?
  grade           String?
  subject         String?
  difficulties    String? // Learning difficulties or areas of struggle
  pricePerLesson  Float? // Price per individual lesson
  pricePerPackage Float? // Price per package of 10 lessons
  usePackages     Boolean   @default(false) // Whether this student uses packages
  credit          Float     @default(0) // Credit balance for student account

  // Parent Details
  parentFullName String?
  parentAddress  String? // If different from student
  parentPhone    String?
  parentEmail    String?

  // Emergency Contact (if different from parent)
  emergencyContactInfo String?

  notes     String?
  archived  Boolean   @default(false)
  familyId  String? // Groups students from the same family for combined finances/reports
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lessons   Lesson[]
  packages  Package[]
  payments  Payment[]

  @@index([userId])
  @@index([firstName, lastName])
  @@index([familyId])
}

model Lesson {
  id                 String    @id @default(uuid())
  userId             String
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentId          String
  student            Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  packageId          String? // Link to package if this lesson was paid with a package
  package            Package?  @relation(fields: [packageId], references: [id], onDelete: SetNull)
  dateTime           DateTime
  duration           Int // in minutes
  subject            String
  notes              String? // Lesson Notes - general notes about the lesson (shown in Calendar/Lessons pages)
  academicNotes      String? // Academic Notes - detailed academic notes per lesson (shown in Extended Info)
  notesFiles         String? // JSON array of file metadata for academic notes: [{fileName, filePath/fileId, storageType, ...}]
  homeworkFiles      String? // JSON array of file metadata: [{fileName, filePath/fileId, storageType, ...}]
  price              Float // individual lesson price
  isPaid             Boolean   @default(false) // Track if lesson has been fully paid
  paidAmount         Float     @default(0) // Amount paid towards this lesson (for partial payments)
  locationType       String    @default("in-person") // remote, in-person
  link               String? // Video call link for remote lessons
  isRecurring        Boolean   @default(false)
  recurringFrequency String? // daily, weekly, monthly, yearly
  recurringEndDate   DateTime?
  recurringGroupId   String? // Groups recurring lessons together
  // iCal-style options
  allDay             Boolean   @default(false) // All-day event
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Many-to-many relationship with payments
  payments LessonPayment[]

  @@index([userId])
  @@index([studentId])
  @@index([dateTime])
  @@index([recurringGroupId])
  @@index([packageId])
}

model Package {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentId   String
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  paymentId   String?   @unique // Link to the payment that created this package
  payment     Payment?  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  name        String
  totalHours  Float // Total hours in the package
  hoursUsed   Float     @default(0) // Hours consumed from the package
  price       Float
  purchasedAt DateTime  @default(now())
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  lessons Lesson[] // Lessons paid with this package

  @@index([userId])
  @@index([studentId])
}

model Payment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentId String // Primary student (for reference and backwards compatibility)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  familyId  String? // If set, this payment applies to the whole family
  packageId String?  @unique // Link to package if this payment is for a package
  package   Package? @relation
  amount    Float
  date      DateTime @default(now())
  method    String // cash, card, bank_transfer
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Many-to-many relationship with lessons
  lessons LessonPayment[]

  @@index([userId])
  @@index([studentId])
  @@index([familyId])
  @@index([date])
}

// Junction table for many-to-many relationship between Lesson and Payment
model LessonPayment {
  id        String   @id @default(uuid())
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  paymentId String
  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  amount    Float // Amount from this payment that goes to this lesson
  createdAt DateTime @default(now())

  @@unique([lessonId, paymentId])
  @@index([lessonId])
  @@index([paymentId])
}

model Purchase {
  id                 String   @id @default(uuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date               DateTime
  description        String
  amount             Float
  category           String? // e.g., "Supplies", "Equipment", "Software", "Travel", "Other"
  vendor             String? // Vendor/supplier name
  paymentMethod      String? // "venmo", "zelle", "credit_card"
  notes              String?
  isRecurring        Boolean  @default(false)
  recurringFrequency String? // "daily", "weekly", "monthly", "yearly"
  recurringEndDate   DateTime?
  recurringGroupId   String? // Groups recurring purchases together
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
  @@index([date])
  @@index([category])
  @@index([recurringGroupId])
}

model Settings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
